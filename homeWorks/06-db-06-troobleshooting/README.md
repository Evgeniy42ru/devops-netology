# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

>Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).
>
>Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 
>
>Вы как инженер поддержки решили произвести данную операцию:
>- напишите список операций, которые вы будете производить для остановки запроса пользователя
>- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB
### Ответ:
Список операций:

Сначала найдём операцию которая выполняется более 3ёх минут.
https://www.mongodb.com/docs/manual/reference/method/db.currentOp/
``` js
db.currentOp(
   {
     "active" : true,
     "secs_running" : { "$gt" : 180 },
     "ns" : /^db1\./
   }
)
```

Далее завршим найденную на первом шаге оперцию.
https://www.mongodb.com/docs/manual/reference/method/db.killOp/
``` js
db.killOp(<opid of the query to kill>);
```

Решить проблему можно используя метод - https://www.mongodb.com/docs/manual/reference/method/cursor.maxTimeMS/#mongodb-method-cursor.maxTimeMS
``` js
db.collection.find(
   { <query> },
   { <projection> }
).maxTimeMS( <milliseconds> )
```

## Задача 2

>Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).
>
>Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 
>
>При масштабировании сервиса до N реплик вы увидели, что:
>- сначала рост отношения записанных значений к истекшим
>- Redis блокирует операции записи
>
>Как вы думаете, в чем может быть проблема?

### Ответ:

Думаю проблема может быть связанна с ростом кол-ва ключей чей срок исеткает в одно и тоже время. Данная ситуация подробно описанна в пункте [Latency generated by expires](https://redis.io/docs/management/optimization/latency/).
 
## Задача 3

>Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
>```python
>InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
>```
>
>Как вы думаете, почему это начало происходить и как локализовать проблему?
>
>Какие пути решения данной проблемы вы можете предложить?

### Ответ:
Описание ошибки - https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html

В нашем случае проблема возникла скорее всего из-за роста кол-ва записей, стандартного времени на приём ответа не хватает. В официальной документации есть рекомендация - увеличить значение net_read_timeout с 30 секунд по умолчанию до 60 секунд или более, достаточного для завершения передачи данных.

## Задача 4


>Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.
>
>После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:
>
>`postmaster invoked oom-killer`
>
>Как вы думаете, что происходит?
>
>Как бы вы решили данную проблему?

### Ответ:

Проблема в нехватке оперативной памяти. 

OOM Killer - это компонент ядра Linux, призванный решать проблему недостатка памяти. Известно, что виртуальной памяти может быть бесконечно много (в пределах адресации), а вот физической - вполне конечное число. Ядро выделяет память процессам "с запасом" в сумме превышающую физическую память системы. В основном, всё разруливается нормально (вся выделенная память одновременно редко требуется), но бывает ситуация когда становится нужно памяти больше, чем ее физически есть. И системе тогда нужно завершить какой-то процесс, чтобы продолжить работу. Вот этим и занимается OOM Killer.

Что можно сделать?
- Увеличить ресурс памяти для psql.
- Ограничить psql путём настройки используемой памяти чтобы он не выходил за рамки и не превышал лимит машины на которой работает.

---